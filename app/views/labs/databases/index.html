<div class="row wrapper border-bottom white-bg page-heading">
  <div class="col-lg-10">
    <h2>Databases at the Edge</h2>
    <ol class="breadcrumb">
      <li>
        <a href="index.html">Home</a>
      </li>
      <li>
        <a>Labs</a>
      </li>
      <li class="active">
        <strong>Databases at the Edge</strong>
      </li>
    </ol>
  </div>
  <div class="col-lg-2">

  </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight" ng-controller="CodeEditorCtrl">
  <div class="row">
    <div class="col-lg-12">

      <!-- Database Lab: Objectives -->
      <div ibox   title="Database Lab: Objectives">
        <!-- Objectives -->
        <div content-block name="database-objectives" message="Read the Objectives">
          <p>Write a NodeJS server that listens to all the MQTT sensor traffic on the network and writes it to a database on the gateway.</p>
          <p>The steps to write the MQTT to database service are as follows:</p>
          <ul>
            <li>Install MongoDB and the MongooseJS database bindings</li>
            <li>Define your database schema using MongooseJS</li>
            <li>Write a NodeJS server that listens to all sensor traffic over MQTT</li>
            <li>Write the collected sensor information to the database.</li>
          </ul>
        </div>
      </div>

      <!-- Create JavaScript Models to represent the Edge Network -->
      <div ibox  title="Create JavaScript Models to represent the Edge Network">
        <div content-block name="defining-database-types" message="Read and Understand the types that we will Defining Types for the Edge Network">

          <h4>Defining Types for the Edge Network</h4>

          <p>As we build our Internet of Things system, we will need to define the objects and events that we want to track on our edge network.</p>
          <p>For this edge network, we will define five types that we will track in the database.</p>

          <ul>
            <li>
              <b>Sensor</b> - this data describes an edge device that publishes data to the Intel Iot Gateway. Examples of sensors include the sensors included in your Intel IoT Developer Kit. For a complete list of supported sensors see the <a href="https://github.com/intel-iot-devkit/upm">libUPM project</a>.
            </li>
            <li>
              <b>Actuator</b> - this data describes an edge device that performs an action and can be triggered by the Intel Iot Gateway. For example, an LCD screen can have text sent to it to be displayed, a servo motor can be told to rotate a certain number of degrees, or a buzzer may be told to activate.  Any device that performs an action is considered an actuator.  Note that actuators usually do not publish sensor data to the network but they may be queried for the current status.
            </li>
            <li>
              <b>Data</b> - the data contained within a single reading from a sensor
            </li>
            <li>
              <b>Trigger</b> - Triggers have a four important aspects: a name, a sensor that it watches, a condition function (a predicate) that returns TRUE or FALSE and a trigger function that performs an action when the predicate function is true. This will be used more in the Automation Lab. It will watch data coming from a temperature sensor. Its predicate function will evaluate if the temperature is greater than 27 degrees, and its action function will send an alert, log a system error and send text to the LCD screen.
            </li>
            <li>
              <b>Error</b> - a text string and a timestamp describing the errors on the edge network.
            </li>
          </ul>

          <div class="alert alert-info">
            <p>Our database will store five types: <b>sensors, actuators, data, trigger and error</b>.</p>
          </div>
        </div>

        <div content-block name="install-mongoosejs" message="Install MongooseJS">
          <h4>Install MongooseJS</h4>
          <!-- TODO We need better instructions for installing mongoose -->

          <p>MongooseJS is an Object Data Manager that letâ€™s you build JavaScript objects that can create, read, validate, update and remove entries from a MongoDB.</p>

          <p>Read through the documentation on building Mongoose Schemas and Models at <a href="http://mongoosejs.com/docs/guide.html">http://mongoosejs.com/docs/guide.html</a> then start the exercise.</p>

          <div class="alert alert-info">
            <p>Be sure that you whitelist the <code>/usr/bin/node</code> executable:</p>
            <code>$ paxctl -Cm /usr/bin/node</code>
          </div>

        </div>

        <div content-block name="create-new-project" message="Create a new project and the project directories">
          <p>Start a new project in a new project directory.</p>

          <p>Create a README file and write into it that this project contains the models for the edge network.</p>

          <p>Install MongooseJS</p>
          <pre><code>$ npm install mongoose --save</code></pre>

          <p>Create a <code>schema</code> directory and change to that directory, <code>cd schema</code>. We will store all of our schema files here. </p>
          <pre><code>$ mkdir schema</code></pre>
        </div>

        <div content-block name="write-mongoosejs-models" message="Define the sensor schema in ./schema/sensor.js">
          <h4>Write Mongoose JS Models to Access MongoDB</h4>

          <p>MongooseJS is an schema-based solution to model MongoDB database objects.  It allows you to easily create, validate, save, update and remove items from your MongoDB.  Everything in MongooseJS starts with a schema.  After a schema is defined it can be used to create a Model, which is the object you will use in your program to access the database.</p>

          <p>If you have any questions be sure you consult the <a href="http://mongoosejs.com/docs/guide.html">The MongooseJS User Guide</a>.</p>

          <p>Let's build a schema for a sensor with the following data types:</p>

          <ul>
            <li>id : String</li>
            <li>name : String</li>
            <li>description : String</li>
            <li>maxfrequency : Number</li>
            <li>active : Boolean</li>
            <li>ioType String.</li>
          </ul>

          <div>
            <p class="label">schema/sensorSchema.js</p>
            <ui-codemirror ui-codemirror-opts="editorOptions">var mongoose = require('mongoose');
var sensorSchema = new mongoose.Schema({
  id: {
    type: String,
    required: true
  },
  name: {
    type: String,
    required: true
  },
  description: {
    type: String,
    required: true
  },
  maxfrequency: {
    type: Number,
    required: true
  },
  frequency: {
    type: Number,
    required: true
  },
  active: {
    type: Boolean,
    required: true
  },
  ioType: {
    type: String,
    required: true
  }
});

module.exports = sensorSchema;</ui-codemirror></div>

  <p>Save this code in the file <code>sensorSchema.js</code> in the <code>schema</code> directory.</p>
  </div>

  <div content-block name="schema-actuator" message="Define the actuator schema in ./schema/actuator.js">
    <p>Here are the rest of the fields for the other types. Please, define them in a similar manner to the <code>sensorSchema</code>.</p>
    <li>
      <p>Define an actuator schema in <code>schema/actuatorSchema.js</code></p>
      <ul>
        <li>id : String</li>
        <li>name : String</li>
        <li>description : String</li>
        <li>maxfrequency : Number</li>
        <li>active : Boolean</li>
        <li>ioType : String</li>
      </ul>
    </li>
  </div>

  <div content-block name="schema-data" message="Define the Data schema in ./schema/data.js ">
    <li>
      <p>Define sensor data schema in <code>schema/dataSchema.js</code></p>
      <ul>
        <li>sensor_id: String</li>
        <li>value: Number</li>
        <li>timestamp: Date</li>
      </ul>
    </li>
  </div>

  <div content-block name="schema-trigger" message="Define the Trigger schema in ./schema/trigger.js ">
    <li>
      <p>Define a Trigger schema in <code>schema/triggerSchema.js</code></p>
      <ul>
        <li>id: String. Holds a unique value for the iot network event</li>
        <li>name: String. A name for the iot network event</li>
        <li>sensor_id: String. A reference to the sensor that will trigger this event</li>
        <li>actuator_id: String. A reference to the actuator that will be activated</li>
        <li>condition: String. A JavaScript function that returns true or false</li>
        <li>triggerFunc: String. A JavaScript function that is executed when the condition is true.</li>
        <li>active: Boolean. If true this Iot Network Event can be triggered, otherwise it is inactive</li>
      </ul>
    </li>
  </div>

  <div content-block name="schema-error" message="Define the Error schema in ./schema/error.js ">
    <li>
      <p>Define a schema for error in <code>schema/errorSchema.js</code></p>
      <ul>
        <li>type: String</li>
        <li>message: String</li>
        <li>timestamp: Date</li>
      </ul>
    </li>
  </div>

  <div content-block name="create-schema-interface-file" message="Create a Module Interface for the Edge Network Objects">
    <h4>Create a Module Interface for the Edge Network Objects</h4>
    <p>In this section there are two goals.  First, we need to package these schemas into a JavaScript module that can be exported and used by other JavaScript Projects. Second, each schema object needs to be coverted into a Model object that can be used to access the database.</p>

    <p>Write this code to <code>/index.js</code> at the root level of this project.</p>
    <p class="label">./index.js</p>
    <div><ui-codemirror ui-codemirror-opts="editorOptions">var mongoose = require('mongoose');
var SensorSchema = require('./schema/sensorSchema.js');
var ActuatorSchema = require('./schema/actuatorSchema.js');
var TriggerSchema = require('./schema/triggerSchema.js');
var DataSchema = require('./schema/dataSchema.js');
var ErrorSchema = require('./schema/errorSchema.js');

module.exports = {
  SensorModel: mongoose.model('SensorModel', SensorSchema),
  ActuatorModel: mongoose.model('ActuatorModel', ActuatorSchema),
  DataModel: mongoose.model('DataModel', DataSchema),
  TriggerModel: mongoose.model('TriggerModel', TriggerSchema),
  ErrorModel: mongoose.model('ErrorModel', ErrorSchema)
};</ui-codemirror>
      </div>
    </div>
  </div>

    <div ibox title="MQTT Sensor Monitoring on the Gateway">
      <div content-block name="read-mqtt-monitoring-intro" message="Read the Introduction to the NodeJS Server Monitoring with MQTT ">
      <p>In this section of the lab, you will write a server named <b>monitord</b></p>
      <p>Now that the database schemas are defined and the sensors are publishing data on the edge network, we can listen to the data and begin to use it to trigger actions or perform edge analytics.</p>
      <p>The purpose of this project is to track new sensors on the edge network and to record their data into the MongoDB database.</p>
    </div>

    <div content-block name="about-topics" message="Read the Overview on MQTT Topics on the Edge Network">
      <h4>Overview on MQTT Topics on the Edge Network</h4>

      <div class="alert alert-info">
        <p>Each sensor is publishing to an MQTT topic that has a three level hierarchy. Here is an example of a possible hierarchy that could be used in an IoT Edge Network.</p>
<pre><code>sensor
    | temperature
        | data
        | error
    | light
        | data
        | error
    | vibration
        | data
        | error
    | sound
        | data
        | error
</code></pre>
      <p>The first level which is just the literal "<b>sensor</b>" which denotes that all of the items under this point in the hierarchy are sensors.</p>
      <p>The second level in the hierarchy is the <b>unique ID of the sensor</b>. This could be a randomly generated unique number or the MAC address of the sensor. In our case, we are using the strings "temperature", "light", "vibration" and "sound" because these are unique on our network.  If the IoT network had more than one temperature sensor, which is ususally the case, then the system should have a different method of assigning unique IDs to each sensor.</p>
      <p>The third describes the <b>type of communication</b> that is coming from the sensor.</p>
      </div>
      <p>The server will be listening to two MQTT topics:</p>
      <ul>
        <li>sensors/+/data</li>
        <li>announcements</li>
      </ul>

      <p>Note the <code>+</code> is a wildcard character that matches any alphanumeric string. In this case, we are using it where the sensor name would be.  This lets us receive data from all sensors on the edge network.</p>

      <p>The <code>monitord</code> does this by listening to all MQTT sensor topics 'sensors/+/data' that are published on the edge network. New sensor data is written to the database.</p>
      <p>The <code>monitord</code> also listens to the MQTT <code>announcements</code> topic, which will carry information on new sensors that are deployed on the network.</p>
    </div>

    <div content-block name="monitord-new-project" message="Create a New Project and Import NPM Modules">
      <h4><a name="sensorMonitor">Create a New Project and Import NPM Modules</a></h4>
      <ol>
        <li>
          <p>Create a new project named <b>monitord</b> and change to that directory.</p>
          <pre><code>$ mkdir monitord
$ cd monitord</code></pre>

          <p class="alert alert-warning">The Intel XDK only deploys to an Intel Edison.  For this project, you will have to upload your project to the Intel IoT Gateway using WinSCP, or create the files in this project directly on the Intel IoT Gateway.</p>
        </li>
        <li>
          <p>Import the MQTT and Mongoose NPM packages by adding them to the package.json file.</p>
          <p>Please note that the <code>intel-commerical-edge-network-database-models</code> package contains the solutions to the exercise where you defined the MongooseJS schema.  They've been packaged and deployed so that you can easily use them in the rest of the labs.</p>
          <p class="subtitle">Recording MQTT Sensor Activity</p>
          <p class="label">./package.json</p>

          <ui-codemirror ui-codemirror-opts="editorOptions">"dependencies": {
  "mqtt": "latest",
  "mongoose": "latest",
  "intel-commerical-edge-network-database-models" : "latest"
}</ui-codemirror>
        </li>

        <li>
          <p>When you upload your code to the Intel IoT Gateway, you will need to login to the console and run <code>npm install</code> in the top of you project directory. This will install the external NPM dependencies.</p>
        </li>
      </ol>
    </div>





    <div content-block name="connect-to-broker-and-database" message="Connect to the MQTT Broker and MongoDB">
      <h4>Connect to the MQTT Broker and MongoDB</h4>
      <p>Create a file called <code>./server.js</code>.  This will be the main entry point into your monitord.</p>

      <p>After importing the MQTT module, setup a connection to the MQTT broker. Your gateway's IP address is <code>192.168.1.1</code> by default.</p>
      <p class="label">./server.js</p>
      <ui-codemirror ui-codemirror-opts="editorOptions">// Require MQTT and setup the connection to the broker
var mqtt = require('mqtt');
var mqttClient = mqtt.connect('mqtt://192.168.1.1');</ui-codemirror>

        <p>Likewise, require the MongooseJS module and setup the connection to the MongoDB server.</p>

        <p class="label">./server.js</p>
        <ui-codemirror ui-codemirror-opts="editorOptions">// Require the MongoDB libraries and connect to the database
var mongoose = require('mongoose');
mongoose.connect(config.mongodb.host);
var db = mongoose.connection;

// Report database errors to the console
db.on('error', console.error.bind(console, 'connection error:'));

// Log when a connection is established to the MongoDB server
db.once('open', function(callback) {
  console.log("Connection to MongoDB successful");
});</ui-codemirror>

        <p>Here we are also demonstrating binding a handler to two database events the <code>open</code> and <code>error</code> events.</p>

        <p>Now import and initialize a sensor and a data model.</p>
        <p class="label">./server.js</p>
        <ui-codemirror ui-codemirror-opts="editorOptions">// Import the Database Model Objects
var DataModel = require('intel-commerical-iot-database-models').DataModel;
var SensorModel = require('intel-commerical-iot-database-models').SensorModel;</ui-codemirror>

        <p>Now that the dependencies are included and the connection code to the MQTT broker and MongoDB database is written. Proceed to create the main loop of the program.</p>
      </div>





    <div content-block name="mqtt-event-loop" message="Subscribe to MQTT topics">
      <h4>The MQTT Event Loop</h4>
      <ol>
          <li>
              <p>Just as you did in the temperature sensor Data Lab create a handler for the MQTT <code>connect</code> event. In this event handler subscribe to the following MQTT topics:</p>

              <ul>
                  <li><code>announcements</code></li>
                  <li><code>sensors/+/data</code></li>
              </ul>
          </li>
          <li>
            <ui-codemirror ui-codemirror-opts="editorOptions">// MQTT connection function
mqttClient.on('connect', function() {
  console.log("Connected to MQTT server");

  // Subscribe to the MQTT topics
  mqttClient.subscribe('announcements');
  mqttClient.subscribe('sensors/+/data');
});</ui-codemirror>
          </li>
          <li>
            <p>An MQTT message will be sent to the <b>announcements</b> topic if a new network sensor comes online in the edge network. The new sensor will reponsible for sending it's own MQTT message.</p>
          </li>

          <li>
              <p>Next, write a handler for the MQTT <code>message</code> event.</p>

              <ui-codemirror ui-codemirror-opts="editorOptions">// A function that runs when MQTT receives a message
mqttClient.on('message', function (topic, message) {

};</ui-codemirror>
          </li>
      </ol>
    </div>

    <div content-block name="decode-incoming-json" message="Decode the incoming JSON message from MQTT">
      <li>Parse the incoming message using a <code>try-catch</code> block and the <code>JSON.parse</code> function.</li>
      <li>
        <ui-codemirror ui-codemirror-opts="editorOptions">// A function that runs when MQTT receives a message
mqttClient.on('message', function(topic, message) {
      var json;
      // Parse the incoming data
      try {
        json = JSON.parse(message);
      } catch (e) {
        console.log(e);
      }</ui-codemirror>
      </li>
    </div>



    <div content-block name="is-announcement" message="Log all announcements to the database">
      <li>
        <p>Decide whether it is a new piece of sensor data or a new announcement. If it is an annoucement then create a new MongoDB sensor object and save it to the database. Handle any database error by printing the error to the console.</p>
          <ui-codemirror ui-codemirror-opts="editorOptions">if (topic.match(/announcements/)) {
  var sensor = new SensorModel(json);
  sensor.save(function(err, sensor) {
    if (err)
      console.log(err);
    else
      console.log(topic + ":" + message.toString());
  });
};</ui-codemirror>
      </li>
    </div>

    <div content-block name="is-data" message="Log all sensor readings to the database">
    <ui-codemirror ui-codemirror-opts="editorOptions">    if (topic.match(/data/)) {
      var value = new DataModel(json);
      value.save(function(err, data) {
        if (err)
          console.log(err);
        else
          console.log(topic + ":" + message.toString());
      });
    }</ui-codemirror>
      </div>
    </div>


        <div ibox   title="Additional Resources">
            <ul>
                <li>
                  <a href="http://mongoosejs.com/docs/guide.html">http://mongoosejs.com/docs/guide.html</a>
                </li>
            </ul>
        </div>
      </div>
  </div>
</div>
