<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Intel® Commercial IoT Workshop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../..//css/main.css">
	<link rel="stylesheet" href="../../../css/codemirror.css">
  </head>
  <body>  
    <header>
      <a href="../../../index.html"><img src="../../../img/intel_logo.png" alt="Intel® logo" width="52" height="35"></a>
    </header>
    <div class="content">

      <h1>Node-Red Flow: Publish Sensor Data over MQTT</h1>

     

      <h2>Login to your Intel® Iot Gateway</h2>

      <p>The commands in this section will be run on the Intel® Iot Gateway so SSH into your Intel® Iot Gateway.</p>

      <p>If you need a reminder, look at <span class="icon bookmark"><a href="/intro/step1/index.html">Step 1: Login to your Intel® Iot Gateway</a></span> from the <em>Intel® Commercial IoT Workshop Intro Module</em>.</p>

      <h2>Setup Screen Window Manager</h2>

      <p>Once you log in the Intel® Iot Gateway, start the <code>screen</code> window manager. </p>
      <p><code>$ screen</code></p>

      <p>You can open multiple console windows, name them and switch between them using screen.  There will be many times when you will want to run several processes at the same time and <code>screen</code> will be very useful to launch them in separate windows.  The another alternative is to simply SSH into the server multiple times.  Of course, in production you will want to launch most processes at boot time using Systemd.</p>
      <ul>
        <p>To create a new console type <code>Ctrl-A C</code></p>
        <p>To name the console type <code>Ctrl-A Shift-A</code></p>
        <p>To get a list of all consoles type <code>Ctrl-A &quot;</code></p>
        
      </ul>

      <h2>Set up the Mosquitto MQTT Broker</h2>

      <ol>

        <li>
          <p>Create a user for your Mosquitto.</p>
          <p><code>$ adduser mosquitto</code></p>
        </li>

        <li>
          <p>Launch the MQTT Broker named mosquitto</p>
          <p><code>$ mosquitto</code></p>
        </li>

      </ol>

         <h2>Create a Node-RED flow</h2>
		 
		 <p>Now you will create a new flow in Node-RED in order to send the temperature data up to your MQTT server.<p>
		 <p>Using the "grove temp sensor", "mqtt" output, "mqtt" input, and "debug" nodes create the following flow:</p>
		 <p><img src="mqtt_flow.png" alt=""></p>
		 <p>Double click the temp node to assign it to pin A0</p>
		 <p> Double click the mqtt nodes to configure them.</p>
		 <p><img src="mqtt_setup.png" alt=""></p>
		 <p>Use the IP address of the gateway as the server and "temp" as the topic</p>
		 <p>When you are done configuring the nodes hit deploy</p>
		  <p><img src="mqtt_flow_connected.png" alt=""></p>
		  <p>In the debug tab you should now see temperature readings from the temperature sensor. Take note, the Edison 
		  is publishing the sensor data to the MQTT server on the Gateway and then pulling the sensor data down into the debug window.</p>

		  
		  <h2>Flow Source Code</h2>
		  <textarea id="code1" class="code">
		  [  
   {  
      "id":"7b901765.846fe8",
      "type":"grove_temp",
      "z":"b4234423.4bdcb8",
      "name":"",
      "pin":"0",
      "interval":"1000",
      "x":90,
      "y":60,
      "wires":[  
         [  
            "446460f6.bb9ba"
         ]
      ]
   },
   {  
      "id":"446460f6.bb9ba",
      "type":"mqtt out",
      "z":"b4234423.4bdcb8",
      "name":"",
      "topic":"temp",
      "qos":"",
      "retain":"",
      "broker":"",
      "x":248,
      "y":61,
      "wires":[  

      ]
   },
   {  
      "id":"8010b7b1.7fef48",
      "type":"mqtt in",
      "z":"b4234423.4bdcb8",
      "name":"",
      "topic":"temp",
      "broker":"",
      "x":84,
      "y":138,
      "wires":[  
         [  
            "9921221a.66dee"
         ]
      ]
   },
   {  
      "id":"9921221a.66dee",
      "type":"debug",
      "z":"b4234423.4bdcb8",
      "name":"",
      "active":false,
      "console":"false",
      "complete":"false",
      "x":246,
      "y":137,
      "wires":[  

      ]
   }
]
</textarea>
		  
		  
      <div class="callout done has-goto-button">
        <p>You should now have a Mosquitto MQTT Broker running the Intel® IoT Gateway. You should also be publishing and reading data from the Broker with the Intel® Edison.</p>
        <p><a href="../sensors/index.html" class="link-button centered">Continue to the next step »</a></p>
      </div>

      <h3>References</h3>

      <ul>
        <li><p><a href="http://mqtt.org/">http://mqtt.org/</a></p></li>
     
      </ul>

    </div>
	
	  <script src="../../../js/codemirror.js"></script>
    <script src="../../../js/mode/javascript/javascript.js"></script>
    <script>
      var editors = ["code1"]

      for (i in editors) {
          console.log(editors[i]);
          CodeMirror.fromTextArea(document.getElementById(editors[i]), {
              lineNumbers: true,
              matchBrackets: true,
              continueComments: "Enter",
              extraKeys: {"Ctrl-Q": "toggleComment"}
          });
      };
    </script>
  </body>
</html>
