<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>MQTT and HTTP devices with Node-Red</h2>
        <ol class="breadcrumb">
            <li>
                <a href="index.html">Home</a>
            </li>
            <li>
                <a>Labs</a>
            </li>
            <li>
                <a>Protocols</a>
            </li>
            <li class="active">
                <strong>MQTT and HTTP devices with Node-Red</strong>
            </li>
        </ol>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight" ng-controller="CodeEditorCtrl">
   <div class="row">
      <div class="col-lg-12">
         <!-- Objective -->
         <div ibox title="Objective">
            <div content-block name="read-objectives" message="Read the Objectives" image-link="./views/labs/protocols-node-red/images/lab3.png">
               <h2 class="labHidden">Read the Objectives</h2>
               <p>In this lab, we will explore using a visual programming tool named <a href="http://node-red.org">Node-Red</a> to build data flows from the edge sensor to the Intel&reg; IoT Gateway.</p>
               <ol>
                  <li>Build a data flow that sends information from the temperature sensors to the LCD screen.</li>
                  <li>Build a data flow that sends information from the temperature sensor to an MQTT broker on the gateway</li>
                  <li>Build a data flow that receives Restful HTTP requests and changes the state of the LCD screen</li>
               </ol>
            </div>
         </div>


        <div ibox title="Overview of Node-Red Service on the Intel&reg; IoT Gateway">
          <div content-block name="start-node-red" message="Be sure that you know how to start and stop the node-red-experience service" image-link="./views/labs/protocols-node-red/images/node-red-experience-running.png">
            <div class="alert alert-info">
              <p>Knowing how to start and stop the node-red-experience service will help tremendously in troubleshooting problems that may arise while developing.</p>
            </div>
            <p>Open a console to the Intel&reg; IoT Gateway and type the following:</p>
            <pre><code>systemctl status node-red-experience</code></pre>
            <p>If you see green text that says, "active (running)" then the Node-Red service is running</p>
            <p>If Node-Red is not running on your gateway then type: </p>
            <pre><code>systemctl start node-red-experience</code></pre>
            <p>This will begin the node-red service.</p>
          </div>

          <div content-block name="start-node-red" message="When you are developing with another IDE, be sure to turn Node-Red off." image-link="./views/labs/protocols-node-red/images/node-red-experience-off.png">
            <div class="alert alert-info">
              <p>If you are developing using the Intel&reg; XDK, Intel System Studio or simply developing directly on the command line, be sure to <b>turn off Node-Red</b></p>
              <p>The reason that you want to turn off Node-Red is because whenever Node-Red is on it will be running the Node-Red flows that are currently on it. These flows will run at the same time as your programs that you are writing in other IDEs.  <b>Node-Red may also already be using the LCD screen or certain GPIO ports. If you attempt to use them in a separate program that you are writing then there may be errors in initializing in the second program. You will get errors in initializing MRAA or the I<sup>2</sup>C bus, and it may not be obvious that this is because Node-Red is also using these resources.</b></p>

            </div>
            <pre><code>systemctl stop node-red-experience</code></pre>
            <p>This will turn off the node-red service.</p>
          </div>
        </div>


        <div ibox title="Node-Red Flow: Temperature to LCD">
          <div content-block name="connect-sensors" message="Install the Grove base shield and sensors" image-link="./views/labs/protocols-node-red/images/temperature-sensors-arduino.jpg">

            <ol>
              <li><p>Install the <b>Grove Base Shield</b> onto the IoT device expansion board.</p></li>
              <li><p>Connect <strong>Grove Temperature Sensor</strong> to analog pin <strong>A0</strong> of the Grove Base Shield.</p></li>
              <li><p>Connect <strong>Grove LCD</strong> display to one of the <strong>I<sup>2</sup>C</strong> pins.</p></li>
            </ol>
          </div>
          <div content-block name="connect-sensors" message="Save current Node-Red flow" image-link="./views/labs/protocols-node-red/images/node-red-export.png">
            <p><b>Save current Node-Red flow</b></p>
            <p>Before we start writing Node-Red flow let's backup the existing flow with following steps:</p>
            <ul>
              <li><p>Select all the nodes in the current flow manually or by doing a 'Ctrl A'</p></li>
              <li><p>Click on the menu button next to Deploy and go to Export->Clipboard as shown in figure</p></li>
              <li><p>Copy the content to a text file and save it</p></li>
              <li><p>Now delete all the nodes and we are ready for a new flow</p></li>
            </ul>
            <div class="alert alert-info">
              <p>Note: It is possible to create multiple Node-Red flows but since all the flows will be deployed simultaneously and we will be using same resources (I<sup>2</sup>C pin, temperature sensor, LCD etc.) there will be contention and hence we use only one flow at a time</p>
            </div>
        </div>
      </div>

          <div ibox title="Node-Red Flow: Publish Sensor Data over MQTT ">
            <labels gateway/>


            <!-- <div content-block name="find-ip-address " message="Review useful commands to help you organize your workflow on the Intel&reg; IoT Gateway ">
<h2 class="labHidden ">Review useful commands to help you organize your workflow on the Intel&reg; IoT Gateway</h2>
              <h5>Setup Screen Window Manager</h5>
              <p>Log into your Intel&reg; Iot Gateway. As a refresher: </p>
              <p>Use Putty or Screen to connect to ip address <b>192.168.1.1</b> and use <b>root</b> as the username and password.</p>
              <p>For more details refer back to the 3rd section of the introduction lab</p>
              <p>Once you log in the Intel&reg; Iot Gateway, start the <code>screen</code> window manager. </p>
              <p><code>$ screen</code></p>

              <p>You can open multiple console windows, name them and switch between them using screen.  There will be many times when you will want to run several processes at the same time and <code>screen</code> will be very useful to launch them in separate windows.  The another alternative is to simply SSH into the server multiple times.  Of course, in production you will want to launch most processes at boot time using Systemd.</p>
              <ul>
                <p>To create a new console type <code>Ctrl-A C</code></p>
                <p>To name the console type <code>Ctrl-A Shift-A</code></p>
                <p>To get a list of all consoles type <code>Ctrl-A &quot;</code></p>
              </ul>

              <h5>Set up the Mosquitto MQTT Broker</h5>
              <ol>
                <li>
                  <p>Create a user for your Mosquitto.</p>
                  <p><code>$ adduser mosquitto</code></p>
                </li>
                <li>
                  <p>For simplicity use <b>root</b> when asked for the UNIX password</p>
                </li>

                <li>
                  <p>Launch the MQTT Broker named mosquitto</p>
                  <p><code>$ mosquitto</code></p>
                </li>
              </ol>
            </div> -->

            <div content-block name="find-ip-address " message="Create a Node-Red flow that will sends the temperature reading to the MQTT broker "
            image-link="./views/labs/protocols-node-red/images/mqtt_flow.png ">
              <h2 class="labHidden ">Create a Node-Red flow that will sends the temperature reading to the MQTT broker</h2>
              <p><img class="labHidden" alt="mqtt flow" data-fid="503933" src="https://software.intel.com/sites/default/files/managed/8a/d4/mqtt_flow.png" title="mqtt flow" typeof="foaf:Image"><strong> </strong></p>

              <h5>Create a Node-RED flow</h5>
              <p>Now you will create a new flow in Node-RED in order to send the temperature data up to your MQTT server.<p>
              <p>Use the:
              <ul>
                <li><b>grove temp sensor</b> from the Intel-gpio section connected to:</li>
                <li><b>function</b> node from the function section connected to:</li>
                <li><b>mqtt</b> node from the output section</li>
              </ul>
              <p>This creates a sequence that will send temperature data over MQTT to a broker.</p>

              <p>Use the
              <ul>
                <li><b>mqtt</b> node from the input section connected to the:</li>
                <li><b>function</b> node from the function section connected to:</li>
                <li><b>debug</b> node from the output section</li>
              </ul>
              <p>This creates a sequence that recives data from a MQTT broker and prints it to the debug console in node-red.</p>
              <div class="alert alert-warning">
                <p>In the next section, we will be build a Restful HTTP service that will control the output of the LCD screen.  At that point, we will delete the flow on the bottom that uses MQTT to update the LCD screeen.</p>
              </div>
            </div>

            <div content-block name="protocol-assign-pins" message="Configure the Grove nodes" image-link="./views/labs/protocols-node-red/images/node-red-grove.png">
              <h2 class="labHidden">Configure the nodes in the MQTT flow</h2>
              <ol>
                <li>Double click the temperature node to assign it to pin <b>A0</b> and change the Platform from Native to <b>Firmata</b> as shown in figure</li>
                <li>Double click the LCD node and change the Platform from Native to <b>Firmata</b> as shown in figure</li>
              </ol>
            </div>

            <div content-block name="protocol-assign-pins" message="Configure the MQTT-TLS nodes" image-link="./views/labs/protocols-node-red/images/node-red-mqtt-tls.png">
              <h2 class="labHidden">Configure the nodes in the MQTT flow</h2>
                <p>Configure <b>both</b> the <b>input mqtt</b> and <b>output mqtt</b> nodes as described below:</p>
                <p>Double click on the output mqtt node and configure it with below steps. Do the same for the input mqtt node</p>
                <ul>
                  <li>Enter the "Server" configuration as <strong>"localhost:8883"</strong>. Here 8883 is the secure TLS port. Also enter Topic as <strong>sensors/temperature/data</strong></li>
                  <li>Next select the pencil icon to edit the server settings. In that check the <strong>Enable secure (SSL/TLS) connection</strong> option and select the pencil icon to edit the TLS configuration</li>
                  <p><img class="labHidden" alt="mqtt edit" data-fid="503934" src="" title="mqtt edit" typeof="foaf:Image"></p>
                  <li>Enter the certificate information as shown in the figure. These are the self signed certificates that we generated in "Setup TLS" lab. Uncheck the "Verify server certificate option"</li>
                  <p><img class="labHidden" alt="mqtt edit" data-fid="503935" src="" title="mqtt edit" typeof="foaf:Image"></p>
                </ul>
            </div>
            <div content-block name="" message="Take Note of the JSON format that you will need to create for this and future labs.">
              <h2 class="labHidden">Configure a Function Node to create the JSON format for the labs</h2>

              <div class="alert alert-info">
                <p>For future labs, it is very important that the JSON that we create has the correct properties.  The JSON format should have 3 properties.</p>
                <ul>
                  <li>sensor_id - a string representing the name of the sensor</li>
                  <li>value - the temperature sensor value</li>
                  <li>timestamp - the time the sensor value was recorded</li>
                </ul>
              </div>
            </div>

            <div content-block name="" message="Configure a Function Node to create the JSON format for the labs">
              <p>Double click the function node and name is <strong>JSONify</strong> and add the following code:</p>
              <p>Note here 0.66 is a correction factor since the temperature sensor is designed to read at 3.3V but for LCD to work we are using 5V</p>
              <ui-codemirror ui-codemirror-opts="editorOptions ">msg.payload = {
    sensor_id: "temperature",
    value: Math.floor(msg.payload*0.66),
    timestamp: Date.now(),
}
return msg;</pre></ui-codemirror>

            <p>If you connect a debug node to the JSONify function node, you should see a JSON object with the correct properties in the Debug tab.</p>
          </div>

          <div content-block name="" message="Configure a Function Node to parse the JSON from MQTT and format it for the LCD">
            <p>Double click the function node and name is <strong>Switch Color on Temperature</strong> and add the following code:</p>
            <ui-codemirror ui-codemirror-opts="editorOptions ">var r_val = 0;
var g_val = 0;
var b_val = 0;

var json = JSON.parse(msg.payload)

if (json.value >= 25) {
  r_val = 255;
  g_val = 0;
  b_val = 0;
} else if (json.value <= 20) {
  r_val = 0;
  g_val = 0;
  b_val = 255;
} else {
  r_val = 0;
  g_val = 255;
  b_val = 0;
}

msg.payload = json.value + "C              "

msg.lcdColor = {
  "r": r_val,
  "g": g_val,
  "b": b_val,
}

msg.lcdCursor = {
    row: 1,
    column: 1,
}

return msg;</pre></ui-codemirror>

          <p>If you connect a debug node to the "Switch Color on Temperature" function node, you should see a JSON object formated for the LCD in the Debug tab.</p>
        </div>



            <div content-block name="protocol-publish-mqtt " message="Deploy the application">
                <h2 class="labHidden ">Deploy the application</h2>
                <p><img class="labHidden" alt="mqtt flow connected" data-fid="503936" src="https://software.intel.com/sites/default/files/managed/a6/3f/mqtt_flow_connected.png" title="mqtt flow connected" typeof="foaf:Image"></p>
              <p>When you are done configuring the nodes hit deploy</p>
              <p>You should see temperature displayed on your LCD and also on the debug window the Json format string</p>
            </div>

            <div content-block name="protocol-publish-mqtt " message="Remove LCD node from flow and deploy again"
            image-link="./views/labs/protocols-node-red/images/node-red-temp.png ">
              <p>To demonstrate we can control actuator (LCD) separately we will now remove the Grove LCD node and move the debug node to the output of function node as shown in figure</p>
              <p>Deploy again and you should see the same temperature output as you saw on your LCD screen</p>
              <p>In the debug tab you should now see temperature readings from the temperature sensor. Take note, the IoT device is publishing the sensor data to the MQTT server on the Gateway and then pulling the sensor data down into the debug window.</p>
              <p> If you do not see the output in the debug window:</p>
              <ul>
                <li>Make sure the you can see the debug window - you  might have to expand it by dragging the right side of the workspace to the center.</li>
                <li>Make sure that the debug tab is selected in the upper right</li>
                <li>Click the tab to the right of the debug node - called msg.payload in your flow</p></li>
              </ul>
            </div>

            <div content-block name="protocol-monitor-mqtt " message="Publish data to the temperature topic ">
              <h2 class="labHidden ">Publish data to the temperature topic</h2>
              <h5>Monitor MQTT Topic on Gateway</h5>
              <p>In order to monitor the MQTT topic on the gateway you will subscribe to the topic using mosquitto.</p>
              <p>In the SSH terminal to the Gateway type:</p>
              <pre><code>mosquitto_sub -t sensors/temperature/data --cafile /etc/tls-certs/certs/server.crt -p 8883 --tls-version tlsv1</pre></code>
              <p>You will start to see the data being published to the "temperature" topic.  This is a great way to help you debug a program that uses MQTT</p>
            </div>

            <div content-block name="node-red-flow2-solution" message="Check out the solution to this exercise">
                <h2 class="labHidden">Check out the solution to this exercise</h2>
                <h5>Flow Source Code</h5>
                <ui-codemirror ui-codemirror-opts="editorOptions"><pre class="brush:jscript;">[
	{
		"id":"f23264de.b85f",
		"type":"function",
		"z":"951c9bfb.3785a",
		"name":"JSONify",
		"func":"msg.payload = {\n    sensor_id: \"temperature\",\n    value: Math.floor(msg.payload*0.66),\n    timestamp: Date.now(),\n}\nreturn msg;",
		"outputs":1,
		"noerr":0,
		"x":501.5,
		"y":139,
		"wires":[["b778a9cf.161728","65d39f57.81cf4"]]
	},
	{
		"id":"c629a5f3.a08b08",
		"type":"upm-grove-temperature",
		"z":"951c9bfb.3785a",
		"name":"",
		"platform":"512",
		"unit":"C",
		"pin":"0",
		"interval":1000,
		"x":200.5,
		"y":137,
		"wires":[["f23264de.b85f"]]
	},
	{
		"id":"65d39f57.81cf4",
		"type":"mqtt out",
		"z":"951c9bfb.3785a",
		"name":"",
		"topic":"sensors/temperature/data",
		"qos":"",
		"retain":"",
		"broker":"67048e4d.0a0518",
		"x":865.5,
		"y":135,
		"wires":[]
	},
	{
		"id":"b778a9cf.161728",
		"type":"debug",
		"z":"951c9bfb.3785a",
		"name":"",
		"active":true,
		"console":"false",
		"complete":"false",
		"x":795.5,
		"y":63,
		"wires":[]
	},
	{
		"id":"fac60b04.05c008",
		"type":"mqtt in",
		"z":"951c9bfb.3785a",
		"name":"",
		"topic":"sensors/temperature/data",
		"qos":"2",
		"broker":"67048e4d.0a0518",
		"x":215.5,
		"y":223,
		"wires":[["263bf844.3a74c"]]
	},
	{
		"id":"263bf844.3a74c",
		"type":"function",
		"z":"951c9bfb.3785a",
		"name":"Switch LCD color",
		"func":"var r_val = 0;\nvar g_val = 0;\nvar b_val = 0;\n\nvar json = JSON.parse(msg.payload)\n\nif (json.value >= 25) {\n  r_val = 255;\n  g_val = 0;\n  b_val = 0;\n} else if (json.value <= 20){\n  r_val = 0;\n  g_val = 0;\n  b_val = 255;\n} else {\n  r_val = 0;\n  g_val = 255;\n  b_val = 0;\n}\n\nmsg.payload = json.value + \"C              \"\n\nmsg.lcdColor = {\n  \"r\": r_val,\n  \"g\": g_val,\n  \"b\": b_val,\n}\n\nmsg.lcdCursor = {\n    row: 1,\n    column: 1,\n}\n\nreturn msg;",
		"outputs":1,
		"noerr":0,
		"x":541.5,
		"y":227,
		"wires":[["a94423ae.49f258"]]},
	{
		"id":"a94423ae.49f258",
		"type":"upm-grove-rgb-lcd",
		"z":"951c9bfb.3785a",
		"name":"",
		"platform":"512",
		"r":0,
		"g":0,
		"b":255,
		"row":0,
		"column":0,
		"x":804.5,
		"y":226,
		"wires":[]
	},
	{
		"id":"67048e4d.0a0518",
		"type":"mqtt-broker",
		"z":"",
		"broker":"localhost",
		"port":"8883",
		"tls":"fbb704ea.f6274",
		"clientid":"",
		"usetls":true,
		"compatmode":true,
		"keepalive":"60",
		"cleansession":true,
		"willTopic":"",
		"willQos":"0",
		"willPayload":"",
		"birthTopic":"",
		"birthQos":"0",
		"birthPayload":""
	},
	{
		"id":"fbb704ea.f6274",
		"type":"tls-config",
		"z":"",
		"name":"",
		"cert":"/etc/tls-certs/certs/server.crt",
		"key":"/etc/tls-certs/certs/server.key",
		"ca":"/etc/tls-certs/ca_certificates/ca.crt",
		"verifyservercert":false
	}
]</pre></ui-codemirror>

                </div>
            </div>

<!-- Restful API -->

            <div ibox title="Node-Red Flow: RESTful API to control LCD screen">
              <div content-block name="node-red-http-intro" message="Read the objective of this section of the lab">
                <h2 class="labHidden">Create Node-RED flow that creates a Restful HTTP API to control the LCD screen</h2>

                <p>In this exercise, you will create a restful HTTP API to control an actuator (LCD Screen) deployed on an edge network. Use the http node to create a flow that controls the LCD with web requests.</p>
                <p>The Restful API will define 6 API endpoints that will allow you to control the display on the LCD</p>

                <div class="alert alert-info">
                  <p>The six APIs are defined as follows:</p>
                  <table class="table-mail">
                    <tr><td><b>GET</b></td><td>/lcd/color</td><td>Query the HTTP Server for the current color value displayed on the LCD</td></tr>
                    <tr><td><b>POST</b></td><td>/lcd/color</td><td>Set a new color to display on the LCD</td></tr>
                    <tr><td><b>DELETE</b></td><td>/lcd/color</td><td>Turn the LCD backlight off</td></tr>
                    <tr><td><b>GET</b></td><td>/lcd/text</td><td>Query the HTTP Server for the current text value displayed on the LCD</td></tr>
                    <tr><td><b>POST</b></td><td>/lcd/text</td><td>Set a new text to display on the LCD</td></tr>
                    <tr><td><b>DELETE</b></td><td>/lcd/text</td><td>Clear text on LCD</td></tr>
                  </table>
                </div>
              </div>

              <div content-block name="restful-api-node-red-flow" message="Open Node Red Flow Editor and create 6 new flows" image-link="./views/labs/protocols-node-red/images/http-text-color-apis.png">
                <p>Note that the picture on the right only shows the 3 flows for the LCD COLOR API.  You need to create an additional 3 flows for the LCD TEXT API.</p>
                <p>Each API defined in this new Node-Red flow will contains the following nodes:</p>
                <ul>
                  <li>http input</li>
                  <li>function</li>
                  <li>http output</li>
                  <li>debug</li>
                  <li>Grove RGB LCD</li>
                </ul>
              </div>

              <div content-block message="Open the HTTP Input node in the first three flows and set the URL to /lcd/color" image-link="./views/labs/protocols-node-red/images/lcdcolor.png">
                <p>Open the <b>HTTP Input</b> node in the first three flows and set the URL to /lcd/color</p>
              </div>

              <div content-block message="Open the HTTP Input node in the first three flows and set the URL to /lcd/color" image-link="./views/labs/protocols-node-red/images/lcd-firmata.png">
                <p>Open the <b>Grove RGB LCD</b> node and set the platform to <b>firmata</b>.</p>
              </div>

              <div content-block message="Insert code into the GET /lcd/color flow's function node">
                <p>Open the <b>Function</b> node in the GET /lcd/color flow and insert the following code:</p>
                <ui-codemirror ui-codemirror-opts="editorOptions"><pre class="brush:jscript;">// Get the color from the global context
// If color is not defined then the default is to turn the LCD off
var color = flow.get('color') || {r:0, g:0, b:0};

// Pass it along in the payload
msg.payload = color;
return msg;</pre></ui-codemirror>
              </div>

              <div content-block message="Insert code into the POST /lcd/color flow's function node">
                <p>Open the <b>Function</b> node in the POST /lcd/color flow and insert the following code:</p>
                <ui-codemirror ui-codemirror-opts="editorOptions"><pre class="brush:jscript;">// isInt
function isInt(value) {
  return !isNaN(value) &&
         parseInt(Number(value)) == value &&
         !isNaN(parseInt(value, 10));
}

var validateHTTPParameters = function(params) {
    return (
      (params.hasOwnProperty('r')
        && params.hasOwnProperty('g')
        && params.hasOwnProperty('b'))
      &&
      (isInt(params.r)
            && isInt(params.g)
            && isInt(params.b))
      &&
        ((params.r >= 0 && params.r <= 255)
           && (params.g >= 0 && params.g <= 255)
           && (params.b >= 0 && params.b <= 255)));
}

// Declare variables
var message = flow.get('message') || "";
var color = {};

// Check if the HTTP query contains r,g,b properties
if (validateHTTPParameters(msg.req.query) === true) {

    // Only the r, g and b properties should be copied
    // to the color variable.
    color =  {
        r: msg.req.query.r,
        g: msg.req.query.g,
        b: msg.req.query.b
    };

    // Store the Color variable in the Node-Red Global Context
    flow.set('color', color);

    // Insert the message and color into the payload
    msg.payload = message;
    msg.lcdColor = color;

    msg.statusCode = 201;  // HTTP Code 201 - Object Successfully Created
} else {;
    msg.statusCode = 400;  // HTTP Code 400 - Bad Request Format
}
return msg;</pre></ui-codemirror>
              </div>

              <div content-block message="Insert code into the DELETE /lcd/color flow's function node">
                <p>Open the <b>Function</b> node in the DELETE /lcd/color flow and insert the following code:</p>
                <ui-codemirror ui-codemirror-opts="editorOptions"><pre class="brush:jscript;">// Get the current message from the global context
var message = flow.get('message') || "";

// This will turn the LCD backlight off
var color = {r:0, g:0, b:0};

// Store the blank color in the Node-Red global context
flow.set('color', color);

msg.payload = message;
msg.lcdColor = color
return msg;</pre></ui-codemirror>
              </div>

              <div content-block message="Insert code into the GET /lcd/text flow's function node">
                <p>Open the <b>Function</b> node in the GET /lcd/text flow and insert the following code:</p>
                <ui-codemirror ui-codemirror-opts="editorOptions"><pre class="brush:jscript;">// Get the color from the global context
// If color is not defined then the default is to turn the LCD off
var message = flow.get('message') || "";

// Pass it along in the payload
msg.payload = message;
return msg;</pre></ui-codemirror>
              </div>

              <div content-block message="Insert code into the POST /lcd/text flow's function node">
                <p>Open the <b>Function</b> node in the POST /lcd/text flow and insert the following code:</p>
                <ui-codemirror ui-codemirror-opts="editorOptions"><pre class="brush:jscript;">// isString
function isString(value) {
  return (typeof value === 'string' || value instanceof String);
}

var validateHTTPParameters = function(params) {
    return params.hasOwnProperty('lcdtext')
            && isString(params.lcdtext);
}

// Declare variables
var message = "";
var color = flow.get('color') || {r:0, g:0, b:0} ;

// Check if the HTTP query contains r,g,b properties
if (validateHTTPParameters(msg.req.query) === true) {

    // Only the r, g and b properties should be copied
    // to the color variable.
    message = msg.req.query.lcdtext

    // Store the Color variable in the Node-Red Global Context
    flow.set('message', message);

    // Insert the message and color into the payload
    msg.payload = message;
    msg.lcdColor = color;

    msg.statusCode = 201;  // HTTP Code 201 - Object Successfully Created
} else {;
    msg.statusCode = 400;  // HTTP Code 400 - Bad Request Format
}
return msg;</pre></ui-codemirror>
              </div>

              <div content-block message="Insert code into the DELETE /lcd/text flow's function node">
                <p>Open the <b>Function</b> node in the DELETE /lcd/text flow and insert the following code:</p>
                <ui-codemirror ui-codemirror-opts="editorOptions"><pre class="brush:jscript;">// Get the current message from the global context
var message = "                 ";

// This will turn the LCD backlight off
var color = flow.get('color');

// Store the blank color in the Node-Red global context
flow.set('message', message);

msg.payload = message;
msg.lcdColor = color
return msg;</pre></ui-codemirror>
              </div>
            </div>


          <div ibox title="Testing Your Restful HTTP API">
            <div content-block name="install-postman" message="Install Postman, a HTTP debugging tool" image-link="./views/labs/protocols-node-red/images/postman_website.png">
                <h2 class="labHidden">Install Postman, a HTTP debugging tool</h2>
                <p><img class="labHidden" alt="postman website" data-fid="503944" src="https://software.intel.com/sites/default/files/managed/96/7a/postman_website.png" title="postman website" typeof="foaf:Image"></p>

                <h5> Install Postman </h5>
                <p><code>Postman</code> is a developer debugging tool that allows developers to send HTTP requests. If you feel more familar with other tools, such as <code>curl</code>, feel free to use it.</p>
                <p>To send web requests to the Intel IoT device we will be using Postman, a Chrome app designed to send web requests.</p>

                <p>To install the app navigate to <a href="https://www.getpostman.com/" target="_blank"> https://www.getpostman.com</a>, Select Chrome App, and install it following the directions given.</p>
            </div>


            <div content-block name="install-postman" message="Use PostMan to send an HTTP request" image-link="./views/labs/protocols-node-red/images/postman.png">
                <h5>Use Postman to send web request </h5>
                <p>Once Postman is installed launch it from the Google Apps Launcher.</p>
                <ul>
                  <li>Select post from the dropdown menu and enter the IP address of your Intel IoT device port 1880 with the URL specified above.</li>
                  <li>Go to "Authorization" tab, select "Basic Auth" from drop down menu. Provide root as Username and enter your gateway password in Password field. </li>
                  <li>The /lcd/color API  can be passed a RGB value like this.
                    <pre><code>http://{gateway ip address}:1880/lcd/color?r=0&g=255&b=0</code></pre>
                  <li>Similarly the /lcd/lcdtext API  can be passed a string value like this.
                    <pre><code>http://{gateway ip address}:1880/lcd/text?lcdtext="Hello World!"</code></pre>

                  </li>
                </ul>
            </div>
          </div>

            <div ibox title="Additional Resources">
              <ul>
                <li><p><a href="http://mqtt.org/" target="_blank">MQTT</a></p></li>
                <li><p><a href="https://www.npmjs.com/package/express" target="_blank">ExpressJS</a></p></li>
                <li><p><a href="https://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank">REST</a></p></li>
              </ul>
            </div>
        </div>
    </div>
