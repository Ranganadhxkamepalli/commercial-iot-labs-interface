<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Intel® Commercial IoT Workshop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../../../../css/main.css">
  <!-- Include CodeMirror CSS-->
  <link rel="stylesheet" href="../../../../css/codemirror.css">
</head>
  <body>
    <header>
      <a href="../../../../index.html"><img src="../../../../img/intel_logo.png" alt="Intel® logo" width="52" height="35"></a>
    </header>
    <div class="content">

      <h1>Node-RED Application on Gateway</h1>

      <div class="tldr">
        Create a node-red application to collect data from sensors, take average of 5 consecutive data and send to cloud service.
      </div>


      <h2>Install and Run Node-RED on Gateway </h2>
      <p>If you have already installed Node-RED on your gateway then you can skip installation step and directly run node-red.</p>
      <p>SSH into your gateway. For more information on steps to Login gateway you can check Step 3 of Module 1 </p>

      <p>Install Node-RED with,
	  <code>$ npm install -g node-red</code>
    </p>
	  <p> You should now run the Node-RED server by typing,
	  <code>$ node-red</code> </p>
    <p> To access Node-RED in your browser, click on <a href="http://192.168.1.1:1880" target="_blank">http://192.168.1.1:1880</a>


    <h2> Create Node-RED application on gateway</h2>
    <ol>
      <li>
        <p>Create following flow using mqtt (input), debug, function and mqtt (output).</p>
        <p><img src="image1.png" alt=""></p>

      </li>

        <li>
          <p>Configure mqtt(input) node.
            Add new Server with server as "localhost" and port number as 1883.
            (Port 1883 is default assigned MQTT port.)
            Add topic for mqtt where sensors are publishing data.
            In this example we have assumed that sensors are publishing data on topic <code>sensors/<b>{{Sensor Id}}</b>/data</code> (i.e sensors/temperature/data where temperature is Sensor Id.)
          </p>
          <p><img src="image2.png" alt=""></p>
        </li>

        <li>
          <p>Configure Function node in a way that collects the data for 5 consecutive values, find an average out of it and send that reduced average data to cloud.
            You can also look into following given code. 
            <strong>Change gatewayId on 2nd line of following code with last 4 digit of your Gaterway Wireless Mac Address.</strong> (i.e Change 1234 to new 4 digit wireless mac address)
          </p>

<textarea id="code1" class="code">
var totalValues = 5; //define the number of values to average
var gatewayId = "1234"; // Enter last 4 digit of your Gateway Wireless Mac Address
var payload = JSON.parse(msg.payload); //parse the payload in JSON format
var data = payload.value; //Save the sensor value

context.valueArray = context.valueArray || []; //setup a persistant array and initalise it
context.count = context.count || 0; //init the counter and set it to 0 if its not already

//take whatever came in and add it to the position "context.count" in context.valueArray

if (msg.payload =="false") {
    context.valueArray[context.count] = 0;
} else {
    context.valueArray[context.count] = parseInt(data);
}

context.count += 1; //add 1 to context count
if (context.count == totalValues) { //if this function has been run x times, then we have all x values
    var value = 0.00; //make a temp variavle and set it to 0

    for (j=0; j < totalValues; j++) {
        //add the value of the item at position j in the array to our temp variable
        value = value + context.valueArray[j];
    }
    var average = parseInt(value/totalValues);

    // Create a new message with topic, payload, qos and retain to send in cloud
    var newMsg = {
        topic:"gateways/" +gatewayId+ "/sensors/" +payload.sensor_id+ "/data",
        payload:
        {
            gateway_id:gatewayId,
            sensor_id: payload.sensor_id,
            value: average,
            timestamp: Date.now()
        },
        qos:0,
        retain:false
    };

    context.count=0; //set the counter back to 0 for the next go
    return [newMsg]; //then shove it out to the next node
}
</textarea>
        <p>The function node will look like below image. </p>
          <p><img src="image3.png" alt=""></p>
        </li>

        <li>
          <p>Configure Mqtt(output) to send data to cloud.
            Add new Server with server as "198.211.103.31" and port number as 1883.
            This is server address of our IoT cloud.
            Leave topic,qos and retain blank because we have already setup all these properties via message properties.
            That node will look like below image.
           </p>
          <p><img src="image4.png" alt=""></p>
        </li>

        <li>
          <p>Configure Mqtt(output) to send data in cloud.
            Add new Server with server as "198.211.103.31" and port number as 1883.
            This is server address of our IoT cloud.
            Leave topic,qos and retain blank because we have already setup all these properties via message properties.
            That node will look like below image.
           </p>
          <p><img src="image4.png" alt=""></p>
        </li>

        <li>
          The Debug node causes any message to be displayed in the Debug sidebar. By default, it just displays the payload of the message, but it is possible to display the entire message object.
        </li>

        <li>
          <p>The final flow of our configuration will look like below shown image. Names of nodes might differ from what you have assigned.</p>
            <p><img src="image5.png" alt=""></p>
        </li>

        <li>
          <p>
            Click the Deploy button to deploy this flow to your gateway. The button to the right of the node will toggle its output on and off so you can de-clutter the debug window.
          </p>
        </li>

      </ol>



<h2> Node-RED Flow Source </h2>
<p> Any flow in Node-RED can be exported / imported as a JSON object.
  The code for the above flow is displayed below. To import it into your work space copy the text, hit Ctrl-I in the Node-RED workspace and paste the text in.
</p>
<p>
<textarea id="code2" class="code">[
     {
        "id":"2d6882db.d2977e",
        "type":"mqtt-broker",
        "z":"173e68b2.e8c197",
        "broker":"198.211.103.31",
        "port":"1883",
        "clientid":"",
        "usetls":false,
        "verifyservercert":true,
        "compatmode":true,
        "keepalive":"60",
        "cleansession":true,
        "willTopic":"",
        "willQos":"0",
        "willRetain":null,
        "willPayload":"",
        "birthTopic":"",
        "birthQos":"0",
        "birthRetain":null,
        "birthPayload":""
     },
     {
        "id":"f6fa250a.0905d8",
        "type":"mqtt-broker",
        "z":"173e68b2.e8c197",
        "broker":"localhost",
        "port":"1883",
        "clientid":"",
        "usetls":false,
        "verifyservercert":true,
        "compatmode":true,
        "keepalive":"60",
        "cleansession":true,
        "willTopic":"",
        "willQos":"0",
        "willRetain":null,
        "willPayload":"",
        "birthTopic":"",
        "birthQos":"0",
        "birthRetain":null,
        "birthPayload":""
     },
     {
        "id":"e6cd80fb.19328",
        "type":"mqtt in",
        "z":"173e68b2.e8c197",
        "name":"Incoming MQTT messages from Sensors",
        "topic":"sensors/temperature/data",
        "broker":"f6fa250a.0905d8",
        "x":366.5,
        "y":242,
        "wires":[
           [
              "a7ffb8a4.580048",
              "3b750487.c48afc"
           ]
        ]
     },
     {
        "id":"a7ffb8a4.580048",
        "type":"function",
        "z":"173e68b2.e8c197",
        "name":"Average of 5 consecutive sensor values",
        "func":"var totalValues = 5; //define the number of values to average\nvar gatewayId = \"1234\"; // Enter last 4 digit of your Gateway Wireless Mac Address\nvar payload = JSON.parse(msg.payload);\nvar data = payload.value;\n\ncontext.valueArray = context.valueArray || []; //setup a persistant array and initalise it\ncontext.count = context.count || 0; //init the counter and set it to 0 if its not already   \n\n//take whatever came in and add it to the position \"context.count\" in context.valueArray\n\nif (msg.payload ==\"false\") {\n    context.valueArray[context.count] = 0;\n} else {\n    context.valueArray[context.count] = parseInt(data);\n}\n\ncontext.count += 1; //add 1 to context count\nif (context.count == totalValues) { //if this function has been run x times, then we have all x values\n    var value = 0.00; //make a temp variavle and set it to 0\n    \n    for (j=0; j<totalValues; j++) {\n        //add the value of the item at position j in the array to our temp variable\n        value = value + context.valueArray[j];\n    }\n    var average = parseInt(value/totalValues);\n    var newMsg = {\n        topic:\"gateways/\" +gatewayId+ \"/sensors/\" +payload.sensor_id+ \"/data\",\n        payload:\n        {\n            gateway_id:gatewayId,\n            sensor_id: payload.sensor_id,\n            value: average,\n            timestamp: Date.now()\n        },\n        qos:0,\n        retain:false\n    };\n    \n    \n  //  var result = {\"value\": String(average)}; //dump the caluulated average and out temp var out\n    // add all the variables to a second message for debug\n  //  var parsedvalueArray = {\"payload\": \"Array = \" + context.valueArray + \"\\npreAverage = \" + value + \"\\nAverage = \" + average};\n    \n    context.count=0; //set the counter back to 0 for the next go\n    return [newMsg]; //then shove it out to the next node\n}",
        "outputs":1,
        "noerr":0,
        "x":512.5,
        "y":368,
        "wires":[
           [
              "c450d142.3baf3",
              "6569b65d.9a9648"
           ]
        ]
     },
     {
        "id":"c450d142.3baf3",
        "type":"mqtt out",
        "z":"173e68b2.e8c197",
        "name":"Outgoing MQTT message to Cloud",
        "topic":"",
        "qos":"",
        "retain":"",
        "broker":"2d6882db.d2977e",
        "x":857.5,
        "y":270,
        "wires":[

        ]
     },
     {
        "id":"6569b65d.9a9648",
        "type":"debug",
        "z":"173e68b2.e8c197",
        "name":"Debug Outgoing MQTT message",
        "active":true,
        "console":"false",
        "complete":"true",
        "x":827.5,
        "y":478,
        "wires":[

        ]
     },
     {
        "id":"3b750487.c48afc",
        "type":"debug",
        "z":"173e68b2.e8c197",
        "name":"Debug Incoming MQTT Messages",
        "active":true,
        "console":"false",
        "complete":"payload",
        "x":760.5555555555555,
        "y":164.44444444444443,
        "wires":[

        ]
     }
  ]</textarea></p>

      <!-- <h2>References</h2>

      <ul>
        <li></li>
      </ul> -->

      <div id="next-steps" class="callout done">
        <p>Your gateway is ready and sending data to cloud for visualization</p>
        <p><a href="../part3/index.html" class="link-button centered">Continue to the next step »</a></p>
      </div>

    </div><!-- end .content -->

    <script src="../../../../js/codemirror.js"></script>
      <script src="../../../../js/mode/javascript/javascript.js"></script>
  	<script>
        for (i=1; i<3; i++) {
            console.log("code" + i);
            var element = document.getElementById("code" + i);

            if (element == null) { continue; }

            CodeMirror.fromTextArea(element, {
                lineNumbers: true,
                matchBrackets: true,
                continueComments: "Enter",
                extraKeys: {"Ctrl-Q": "toggleComment"}
            });
        };
       </script>


  </body>
</html>
