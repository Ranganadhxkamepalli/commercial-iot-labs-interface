<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Build an Edge Device</h2>
        <ol class="breadcrumb">
            <li>
                <a href="index.html">Home</a>
            </li>
            <li>
                <a>Labs</a>
            </li>
            <li class="active">
                <strong>Build an Edge Device</strong>
            </li>
        </ol>
    </div>
    <div class="col-lg-2">

    </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight" ng-controller="CodeEditorCtrl">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Objective</h5>

                    <div ibox-tools></div>
                </div>

                <div class="ibox-content">
                    <p>In this lab, we will explore the using a visual programming tool named <a href="http://node-red.org">Node-Red</a> to build data flows from the edge sensor to the Intel® IoT Gateway.</p>

                </div>
            </div>

            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Node-Red Flow: Temperature to LCD</h5>
                    <div ibox-tools></div>
                </div>

                <div class="ibox-content collapse">

                    <h2>Assemble Sensors</h2>

                    <ol>
                        <li>
                            <p>Install the Grove Base Shield onto the Intel® Edison Arduino expansion board.</p>
                            <p>Connect <strong>Grove Temperature Sensor</strong> to analog pin <strong>A0</strong> of the Grove Base Shield.</p>
                            <p>Connect <strong>Grove LCD</strong> display to one of the <strong>I2C</strong> pins.</p>
                            <p><img src="./views/labs/edge-device/nodered/part1/image_2.jpg" alt="" ></p>
                        </li>

	                      <h2>Install and run Node-RED</h2>

                        <p>Log into the Intel® Edison over serial like in Step 3 of Module 1.</p>
	                      <p>First get the ip address of the Edison:</p>
	                      <code>$ ifconfig wlan0</code>
	                      <p><img src="./views/labs/edge-device/nodered/part1/ifconfig.png" alt="" ></p>
	                      <p>The ip address is the address following inet addr. In the case above it is: 10.175.154.190, however yours will be different. Remeber this address for the following step.</p>
                        <p>Install Node-RED with:</p>

	                      <p><code>$ npm install -g node-red</code></p>

                        <p>Once Node-RED is installed you will have to add the custom nodes that will be used to interact with
	                          the temperature sensor and LCD display</p>

                        <p>To install the Node-RED nodes needed use:</p>
	                      <code>$ npm install -g node-red-contrib-grove-sensors-edison </code>

	                      <p> You should now run the Node-RED server by typing:</p>
	                      <code>$ node-red</code>

                        <h2>Program the first flow</h2>

                        <p>Make sure that your laptop is connected to the same WiFi network as your Edison and navigate to Edison IP: port 1880 in your browser. 
		                        If you were using the IP address above you would enter 10.175.154.190:1880 into your navigation bar.</p>

		                    <p><img src="./views/labs/edge-device/nodered/part1/new_node_red.png" alt="" ></p>
		                    
		                    <p> Create a flow where a grove temp sensor node outputs into a function node which outputs into the grove-lcd node. </p>
		                    <p><img src="./views/labs/edge-device/nodered/part1/first_flow.png" alt="" ></p>
		                    <p> Double click on the Temp node and assign A0 as the pin and interval as 1000 to take a temperature reading every 1000ms. Double click the function node and enter the following code:</p>
                        <ui-codemirror ui-codemirror-opts="editorOptions">    var r_val = 0;
    var g_val = 0;
    var b_val = 0;

    if (msg.payload >= 25) {
      r_val = 255;
      g_val = 0;
      b_val = 0;
    } else if (msg.payload <= 20) {
      r_val = 0;
      g_val = 0;
      b_val = 255;
    } else {
      r_val = 0;
      g_val = 255;
      b_val = 0;
    }

    msg.payload = {
      "r": r_val,
      "g": g_val,
      "b": b_val,
      "text": String(msg.payload) + " C"
    }
    return msg;                        
                        </ui-codemirror>

                        <p>Click Deploy in the top right corner</p>
	                      
	                      <h2>Flow source code</h2>
	                      <br>
	                      <p>Any flow in Node-RED can be exported / imported as a JSON object. To create the JSON, select the nodes you wish to 
		                        export, and select Export -> Clipboard from the drop down menu. The code for the above flow is displayed below. To import it into your 
		                        work space copy the text, hit Ctrl-I in the Node-RED workspace and paste the text in. This method provides 
		                        a simple way to share your flows with other developers.</p>
		                    <ui-codemirror ui-codemirror-opts="editorOptions"> 		[  
   {  
      "id":"f7b5c41d.084a38",
      "type":"grove-lcd",
      "z":"b4234423.4bdcb8",
      "name":"",
      "x":400,
      "y":60,
      "wires":[  

      ]
   },
   {  
      "id":"f341d7c2.0cbe28",
      "type":"function",
      "z":"b4234423.4bdcb8",
      "name":"",
      "func":"var r_val = 0;\nvar g_val = 0;\nvar b_val = 0;\n\nif (msg.payload >= 25){\n    r_val = 255;\n    g_val = 0;\n    b_val = 0;\n}\n\nelse if (msg.payload <= 20){\n    r_val = 0;\n    g_val = 0;\n    b_val = 255;\n    \n}\nelse {\n    r_val = 0;\n    g_val = 255;\n    b_val = 0;\n    \n}\n\nmsg.payload = {\"r\":r_val, \"g\":g_val, \"b\":b_val, \"text\":String(msg.payload) + \" C\"}\nreturn msg;",
      "outputs":1,
      "noerr":0,
      "x":250,
      "y":60,
      "wires":[  
         [  
            "f7b5c41d.084a38"
         ]
      ]
   },
   {  
      "id":"7b901765.846fe8",
      "type":"grove_temp",
      "z":"b4234423.4bdcb8",
      "name":"",
      "pin":"0",
      "interval":"1000",
      "x":90,
      "y":60,
      "wires":[  
         [  
            "f341d7c2.0cbe28"
         ]
      ]
   }
]
		                    </ui-codemirror>
		                    
		                    <p> NOTE: if the JSON references any custom nodes those will have to be installed first. </p>

                        
                </div>
            </div>

            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Node-Red Flow: Publish Sensor Data over MQTT</h5>
                    <div ibox-tools></div>
                </div>

                <div class="ibox-content collapse">


                    <h2>Login to your Intel® Iot Gateway</h2>

                    <p>The commands in this section will be run on the Intel® Iot Gateway so SSH into your Intel® Iot Gateway.</p>

                    <p>If you need a reminder, look at <span class="icon bookmark"><a href="/intro/step1/index.html">Step 1: Login to your Intel® Iot Gateway</a></span> from the <em>Intel® Commercial IoT Workshop Intro Module</em>.</p>

                    <h2>Setup Screen Window Manager</h2>

                    <p>Once you log in the Intel® Iot Gateway, start the <code>screen</code> window manager. </p>
                    <p><code>$ screen</code></p>

                    <p>You can open multiple console windows, name them and switch between them using screen.  There will be many times when you will want to run several processes at the same time and <code>screen</code> will be very useful to launch them in separate windows.  The another alternative is to simply SSH into the server multiple times.  Of course, in production you will want to launch most processes at boot time using Systemd.</p>
                    <ul>
                        <p>To create a new console type <code>Ctrl-A C</code></p>
                        <p>To name the console type <code>Ctrl-A Shift-A</code></p>
                        <p>To get a list of all consoles type <code>Ctrl-A &quot;</code></p>
                    </ul>

                    <h2>Set up the Mosquitto MQTT Broker</h2>
                    <ol>
                        <li>
                            <p>Create a user for your Mosquitto.</p>
                            <p><code>$ adduser mosquitto</code></p>
                        </li>
                        
                        <li>
                            <p>Launch the MQTT Broker named mosquitto</p>
                            <p><code>$ mosquitto</code></p>
                        </li>
                    </ol>

                    <h2>Create a Node-RED flow</h2>

		                <p>Now you will create a new flow in Node-RED in order to send the temperature data up to your MQTT server.<p>
		                    <p>Using the "grove temp sensor", "mqtt" output, "mqtt" input, and "debug" nodes create the following flow:</p>
		                    <p><img src="./views/labs/edge-device/nodered/part2/mqtt_flow.png" alt=""></p>
		                    <p>Double click the temp node to assign it to pin A0</p>
		                    <p> Double click the mqtt nodes to configure them.</p>
		                    <p><img src="./views/labs/edge-device/nodered/part2/mqtt_setup.png" alt=""></p>
		                    <p>Use the IP address of the gateway as the server and "temp" as the topic</p>
		                    <p>When you are done configuring the nodes hit deploy</p>
		                    <p><img src="./views/labs/edge-device/nodered/part2/mqtt_flow_connected.png" alt=""></p>
		                    <p>In the debug tab you should now see temperature readings from the temperature sensor. Take note, the Edison is publishing the sensor data to the MQTT server on the Gateway and then pulling the sensor data down into the debug window.</p>


		                    <h2>Flow Source Code</h2>
                        <ui-codemirror ui-codemirror-opts="editorOptions">
		  [  
   {  
      "id":"7b901765.846fe8",
      "type":"grove_temp",
      "z":"b4234423.4bdcb8",
      "name":"",
      "pin":"0",
      "interval":"1000",
      "x":90,
      "y":60,
      "wires":[  
         [  
            "446460f6.bb9ba"
         ]
      ]
   },
   {  
      "id":"446460f6.bb9ba",
      "type":"mqtt out",
      "z":"b4234423.4bdcb8",
      "name":"",
      "topic":"temp",
      "qos":"",
      "retain":"",
      "broker":"",
      "x":248,
      "y":61,
      "wires":[  

      ]
   },
   {  
      "id":"8010b7b1.7fef48",
      "type":"mqtt in",
      "z":"b4234423.4bdcb8",
      "name":"",
      "topic":"temp",
      "broker":"",
      "x":84,
      "y":138,
      "wires":[  
         [  
            "9921221a.66dee"
         ]
      ]
   },
   {  
      "id":"9921221a.66dee",
      "type":"debug",
      "z":"b4234423.4bdcb8",
      "name":"",
      "active":false,
      "console":"false",
      "complete":"false",
      "x":246,
      "y":137,
      "wires":[  

      ]
   }]</ui-codemirror>
                    </p>
                    </p>
                </div>
            </div>


            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Node-Red Flow: HTTP POST to LCD screen</h5>
                    <div ibox-tools></div>
                </div>

                <div class="ibox-content collapse">
                    <h3>Create Node-RED flow that controls the LCD screen with a web request.</h3>

                    <p>In this exercise, you will create a restful HTTP API to control an actuator (LCD Screen) deployed on an edge network. Use the http node to create
		                    a flow that controls the LCD with web requests.</p>

		                <h2> Create Node-RED Flow </h2>
		                <p>Use the input http, debug, grove-lcd, and http response nodes to create the flow below:</p> 
	                  <p><img src="./views/labs/edge-device/nodered/part3/post_flow.png" alt="" ></p>
	                  <p> The input http node will listen to a request sent to a specific URL on the local host on port 1880. Once a request is recived this node will pass the payload to the debug colsole, Grove LCD node, and http response node. The http response 
	                      node will send a response to the sender of the request to let it know that the message was recieved. Double click the input http node to configure it:</p>
	                  <p><img src="./views/labs/edge-device/nodered/part3/config_post.png" alt="" ></p>
	                  <p>For this example use POST as the method and /LCD as the URL. </p>
	                  <h2> Install Postman </h2>

	                  <p>To send web requests to the Intel® Edison we will be using Postman, a Chrome app designed to send web requests.</p>
	                  <p><img src = "./views/labs/edge-device/nodered/part3/postman_website.png" alt=""></p> 

	                  <p>To install the app navigate to <a href ="https://www.getpostman.com/"> https://www.getpostman.com</a> ,
	                      Select Chrome App, and install it following the directions given.</p>

	                  <h2> Use Postman to send web request </h2>
	                  <p>Once Postman is installed launch it from the Google Apps Launcher.</p>
	                  <p><img src="./views/labs/edge-device/nodered/part3/postman.png" alt="" ></p>
	                  <p>Select post from the dropdown menu and enter the IP address of your Intel® Edison port 1880 with the URL specified above.
	                      In this case it is "10.175.152.15:1880/LCD". The Grove LCD node requires a specific message to change the backlight color and
	                      display text. The message must be a JSON with the structure: {"r":r_val,"g":g_val,"b":b_bal,"text":"text to print"} where r_val, g_val, and b_val
	                      are the red, green and blue color values from 0-255. This structure is also specified in the grove-lcd node info tab. 
	                  </p><p>To have Postman send a request
	                      with this syntax slect the "Body" tab, click the "raw" radial button, and select JSON from the dropdown menu. Now enter the JSON specifed above 
	                      entering the color values and message you wish to display. When you are ready hit "Send".</p>
	                  <p><img src="./views/labs/edge-device/nodered/part3/post_flow_posted.png" alt="" ></p>
	                  <p>If everything has worked properly your LCD should change to the color specifed and display your text. Also the debug tag will show the message that was 
	                      recieved, or any errors that were encountered. </p>

                    <h3>Overview of Restful API for controlling the LCD Screen</h3>
                    <p>You have created the restful API for:</p>
	                  <p><b>POST /LCD</b> - which allows you to comtrol the text and backlight.</p>
	                  <p>In the following step you will add the following restful APIs:</p>
                    <ul>
                        <li><b>GET /lcd/backlight</b> - Retrieves the current status of the LCD backlight</li>

                        <li><b>DELETE /lcd/backlight</b> - Turns the LCD backlight off</li>
                        
                        <li><b>GET /lcd/text</b> - Retrieves the current status of the LCD text</li>
                        
                        <li><b>DELETE /lcd/text</b> - Turns the LCD text off</li>
                    </ul>
                </div>
            </div>


            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>References</h5>
                    <div ibox-tools></div>
                </div>

                <div class="ibox-content collapse">
                    <ul>
                        <li><p><a href="http://mqtt.org/">http://mqtt.org/</a></p></li>
                        <li><p><a href="https://www.npmjs.com/package/express">https://www.npmjs.com/package/express</a></p></li>
                        <li><p><a href="https://en.wikipedia.org/wiki/Representational_state_transfer">https://en.wikipedia.org/wiki/Representational_state_transfer</a></p></li>
                    </ul>
                </div>
            </div>



    </div>
</div>
